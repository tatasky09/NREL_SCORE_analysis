---
title: "021_vulerability_index"
author: "SimanNing"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

- The largest problem comes from the 0 and 1 --> no NA leads to some 

```{r cars}
library(table1)
library(tidyverse)
load("D:/01PHD/000NREL_SCORE/04analysis/data/useful_set_11_18.RData") ##will load df2 exactly same as the one in the previous script
## filled all NA with "missing"
data <- df2  %>% mutate(across(everything(), ~replace_na(., "missing")))%>% select(-starts_with("idx"))

##drop any columns starts with "idx"


# 2. Get Census Block Group Boundaries
# Replace 'STATE' and 'COUNTY' with the correct FIPS codes for the state and county you're working with
##get the block group boundaries
library(tigris)
census_boundaries <- block_groups(state = "WA", county = "King", class = "sf")

# Transform the coordinate system of the census boundaries to match the Excel data
census_boundaries_sf <- st_transform(census_boundaries, crs = st_crs(df_sf))

##get median income category from census block group and tract
library(tidycensus)
library(tidyverse)
library(sf)

# Get the median income for each census tract -- block group data has missing values
median_income <- get_acs(geography = "tract", 
                         variables = "B19013_001", 
                         state = "WA", 
                         county = "King", 
                         geometry = TRUE)

##do a spatial join of data_sf and median_income
data_sf <- st_as_sf(data, coords = c("longitude", "latitude"), crs = 4326)
data_sf <- st_transform(data_sf, crs = st_crs(median_income))
data_sf <- st_join(data_sf, median_income)
data <- data_sf %>% st_drop_geometry()



colnames(df2[1:70])
table(data$hh_income)
table(data$household_race_selected)
colnames(idx_frequency_subset)
# VI <- data2[1:77,]  %>% mutate(across(everything(), ~replace_na(., "missing")))%>% 
#   mutate(response_ID = ResponseId,
#     no_vehicle = ifelse(grepl("car", primary_transport_mode_selected , ignore.case = TRUE), 0,1), 
#          no_back_up_energy = ifelse(grepl("no", backup_energy_system, ignore.case = TRUE), 1,0),
#          #Income_lower_than_median = ifelse(grepl("$90,000 to $99,999", Q19, ignore.case = TRUE), 0,1),
#          less_than_highschool_education = ifelse(grepl("Less than High School", education_level, ignore.case = TRUE), 1,0),
#          children_under_18 = ifelse(grepl(0, under_18_count, ignore.case = TRUE), 0,1),
#          children_under_5 = ifelse(grepl(0, under_5_count, ignore.case = TRUE), 0,1),
#          children_6_to_18 = children_under_18 - children_under_5,
#          single_parent_house = ifelse(grepl("yes",single_parent_hh, ignore.case = TRUE), 1,0),
#          members_over_65 = ifelse(grepl("0", over_65_count, ignore.case = TRUE), 0,1),
#          language_other_than_eng = ifelse(grepl("missing",languages_other , ignore.case = TRUE), 0,1),
#          renter = ifelse(grepl("rented", home_ownership, ignore.case = TRUE), 1,0),
#          non_white = ifelse(grepl("white", household_race_selected, ignore.case = TRUE), 0,1),
#          african_american =  ifelse(grepl("black", household_race_selected, ignore.case = TRUE), 1,0),
#          hispanic_latino = ifelse(grepl("0", hispanic_latino_count, ignore.case = TRUE), 0,1),
#          condition_worsened_by_blackout = ifelse(grepl("yes", condition_worsened_by_outage, ignore.case = TRUE), 1,0),
#          medical_device = ifelse(grepl("yes", electric_device_dependent, ignore.case = TRUE), 1,0),
#          prescription_medicine = ifelse(grepl("yes", prescription_med, ignore.case = TRUE), 1,0), .keep = "used")




```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
#TODO: check the language idx
library(tidyverse)
unique(data$under_5_count)
###get the median income of sample and ignore missing
median_income_NB1 <- data %>% group_by(neighborhood,hh_income) %>% tally() #median_income = median(as.numeric(gsub(",|\\$| or more|missing", "", gsub(".* \\$", "",hh_income))))

###filter only not NA values
median_income_NB1 <- median_income_NB1 %>% filter(hh_income != "missing") %>% group_by(neighborhood) %>% summarise(median_income = median(as.numeric(gsub(",|\\$| or more|missing", "", gsub(".* \\$", "",hh_income)))))

VI <- data %>% 
  mutate(across(everything(), ~replace_na(., "missing"))) %>% 
  mutate(
    idx_no_vehicle = ifelse(primary_transport_mode_selected == "missing", "missing", ifelse(grepl("car", primary_transport_mode_selected, ignore.case = TRUE), 0, 1)), 
    idx_no_back_up_energy = ifelse(backup_energy_system == "missing", "missing", ifelse(grepl("no", backup_energy_system, ignore.case = TRUE), 1, 0)),
    idx_less_than_highschool_education = ifelse(education_level == "missing", "missing", ifelse(grepl("Less than High School", education_level, ignore.case = TRUE), 1, 0)),
    idx_children_under_18 = ifelse(under_18_count == "missing", "missing", ifelse(grepl(0, under_18_count, ignore.case = TRUE), 0, 1)),
    idx_children_under_5 = ifelse(under_5_count == "missing", "missing", ifelse(grepl(0, under_5_count, ignore.case = TRUE), 0, 1)),
    idx_children_6_to_18 = 
      case_when(
        under_18_count == "missing" ~ "missing",
        under_18_count == "0" ~ "0",
        as.numeric(gsub(" or more","",under_18_count)) - as.numeric(under_5_count)>0 ~ "1",
        TRUE ~ "0"),
    idx_single_parent_house = ifelse(single_parent_hh == "missing", "missing", ifelse(grepl("yes", single_parent_hh, ignore.case = TRUE), 1, 0)),
    idx_members_over_65 = ifelse(over_65_count == "missing", "missing", ifelse(grepl(0, over_65_count, ignore.case = TRUE), 0, 1)),
    ### do a final check on this!!!
    idx_language_other_than_eng = ifelse(languages_other == "missing", "missing", ifelse(grepl("missing", languages_other, ignore.case = TRUE), 0, 1)),
    idx_renter = ifelse(home_ownership == "missing", "missing", ifelse(grepl("rented", home_ownership, ignore.case = TRUE), 1, 0)),
    idx_non_white = ifelse(household_race_selected == "missing", "missing", ifelse(!grepl("white:", household_race_selected, ignore.case = TRUE), 1, 0)),
    idx_african_american = ifelse(household_race_selected == "missing", "missing", ifelse(grepl("black", household_race_selected, ignore.case = TRUE), 1, 0)),
    idx_two_races = ifelse(household_race_selected == "missing", "missing", ifelse(grepl('Two or more races:|,', household_race_selected, ignore.case = TRUE), 1, 0)),
    idx_asian = ifelse(household_race_selected == "missing", "missing", ifelse(grepl('Asian', household_race_selected, ignore.case = TRUE), 1, 0)),
    idx_hispanic_latino = ifelse(hispanic_latino_count == "missing", "missing", ifelse(grepl("0", hispanic_latino_count, ignore.case = TRUE), 0, 1)),
    idx_condition_worsened_by_blackout = ifelse(condition_worsened_by_outage == "missing", "missing", ifelse(grepl("yes", condition_worsened_by_outage, ignore.case = TRUE), 1, 0)),
    idx_medical_device = ifelse(electric_device_dependent == "missing", "missing", ifelse(grepl("yes", electric_device_dependent, ignore.case = TRUE), 1, 0)),
    idx_prescription_medicine = ifelse(prescription_med == "missing", "missing", ifelse(grepl("yes", prescription_med, ignore.case = TRUE), 1, 0)),
    idx_lower_than_tract_median_income =  ifelse(hh_income == "missing", "missing",ifelse(
         as.numeric(gsub(",|\\$| or more", "", gsub(".* \\$", "",hh_income)))< estimate,1,0)) #,
  ) ##select only columns that contains idx or contains 'response_id'
gsub(",|\\$| or more", "", gsub(".* \\$", "",data$hh_income))


VI <- VI %>% select(starts_with("idx") | starts_with("response_id"))
VI_NA <- VI %>%
  mutate(across(where(is.character), ~ na_if(., "missing")))

write.csv(VI_NA, "D:/01PHD/000NREL_SCORE/04analysis/data/Vulerability_Index_1129.csv", row.names = FALSE)

useful_set <- left_join(data, VI_NA, by = "response_id")

save(useful_set, file = "D:/01PHD/000NREL_SCORE/04analysis/data/useful_set_11_29.RData")
```

```{r}
###run bar plot to plot VI all variables starts with idx
library(ggplot2)
library(dplyr)

for (col in colnames(VI)[1:ncol(VI)]){
  print(col)
  print(table(VI[[col]]))
  ggplot(VI, aes_string(x = col)) +
    geom_bar() +
    labs(title = col)
}



```

```{r}

```


